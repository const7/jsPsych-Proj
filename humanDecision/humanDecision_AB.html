<!DOCTYPE html>
<html>

<head>
    <title>My experiment</title>
    <script src="../jspsych.js"></script>
    <script src="../plugins/jspsych-cloze.js"></script>
    <script src="../plugins/jspsych-drawing.js"></script>
    <script src="../plugins/jspsych-html-keyboard-response.js"></script>
    <link href="../css/jspsych.css" rel="stylesheet" type="text/css">
    </link>
</head>

<body></body>

<script>
    /* create timeline */
    var timeline = [];

    /* welcome message */
    var welcome = {
        type: "html-keyboard-response",
        stimulus: "<p>欢迎参加我们的实验，该实验是为了探索人们的社会决策行为</p><p style='font-size:.8rem;font-style:italic'>按任意键继续</p>"
    };
    timeline.push(welcome);

    /* instructions */
    var instructions = {
        type: "html-keyboard-response",
        stimulus: "<p>在该实验中，您将与玩家B共同参加社交互动游戏.</p>" +
            "<p>屏幕上将显示一个线段，线段两端被大小不同的矩形遮挡。</p>" +
            "<p><strong>请估计线段的中点，越接近真实中点得分越高。</strong></p>" +
            "<p>玩家C会根据你们的任务表现及xxxx判定每轮获胜者。</p>" +
            "<p style='font-size:.8rem;font-style:italic'>按任意键继续</p>",
        post_trial_gap: 500
    };
    timeline.push(instructions);

    /* choose line midpoint */
    // midpoint: record midpoint abscissa of the line
    // line_length: length of line
    // sum_point: player's point at each start
    var midpoint, line_length, sum_point = 0;
    var choose = {
        type: "drawing",
        drawFunc: function (canvas, context) {
            // get coordinate of center
            var center_x = window.innerWidth / 2;
            var center_y = window.innerHeight / 2;
            // generate line length
            var line_left = Math.random() * 300 + 20;
            var line_right = Math.random() * 300 + 20;
            // pick rectangle position
            var dis_left = Math.random() * (line_left - 11) + 10;
            var dis_right = Math.random() * (line_right - 11) + 10;
            // generate rectangle's width and half-height
            var width_left = Math.random() * 200 + (line_left - dis_left);
            var width_right = Math.random() * 200 + (line_right - dis_right);
            var half_height_left = Math.random() * 100 + 10;
            var half_height_right = Math.random() * 100 + 10;
            
            midpoint = (2 * center_x + line_right - line_left) / 2;
            line_length = line_left + line_right;

            // draw left rectangle
            context.beginPath();
            // context.fillStyle = "rgba(0, 0, 200)";       // used for test
            context.fillRect(center_x - dis_left - width_left, center_y - half_height_left, width_left, half_height_left * 2);
            context.closePath();
            // draw right rectangle
            context.beginPath();
            context.fillRect(center_x + dis_right, center_y - half_height_right, width_right, half_height_right * 2);
            context.closePath();
            // draw line
            context.beginPath();
            context.moveTo(center_x - line_left, center_y);
            context.lineTo(center_x + line_right, center_y);
            context.lineWidth = 2;
            context.strokeStyle = "black";
            context.stroke();
            context.closePath();

            // for test
            // context.beginPath();
            // context.moveTo(midpoint, center_y - 10);
            // context.lineTo(midpoint, center_y + 10);
            // context.lineWidth = 2;
            // context.strokeStyle = "black";
            // context.stroke();
            // context.closePath();
        },
        response_type: "mouse",
        on_finish: function(data) {
            var x = parseFloat(data.click_x);
            if (x < midpoint - line_length / 2 || x > midpoint + line_length / 2) {
                data.score = 0;
            } else {
                data.score = Math.ceil((1 - 2 * Math.abs(x - midpoint) / line_length) * 100);
            }
            // add 10 point for sum_point each trial
            sum_point += 10;
        }
    };

    /* display score */
    var grade = {
        type: "html-keyboard-response",
        stimulus: function () {
            return "<p>你的任务得分为 (0-100)：</p><strong>" + jsPsych.data.get().last(1).values()[0].score + "</strong>" +
             " 分" + "<p style='font-size:.8rem;font-style:italic'>按任意键继续</p>";
        }
    }

    /* bribe the judge */
    var bribe = {
        type: "cloze",
        text: function() {
            return "你愿意付出多少点数给玩家C：%% (0-10)\n" + "当前剩余点数: " + sum_point;
        },
        on_finish: function(data) {
            answer = parseInt(data.answers[0]);
            // answer != answer ==>> answer is NaN
            if (answer != answer || answer < 0) {
                answer = 0;
            } else if (answer > 10) {
                answer = 10;
            }
            // save bribe to data
            data.bribe = answer;
            // update sum_point
            sum_point -= answer;
            // save sum_point
            data.final_point = sum_point;
        }
    };

    var trial_pro = {
        timeline: [choose, grade, bribe],
        repetitions: 2,
    };
    timeline.push(trial_pro);

    /* start the experiment */
    jsPsych.init({
        timeline: timeline,
        on_finish: function () {
            jsPsych.data.displayData();
        }
    });
</script>

</html>